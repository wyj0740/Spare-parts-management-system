{% extends "base.html" %}

{% block title %}备件详情 - 备品备件管理系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 返回按钮 -->
    <div class="mb-3">
        <button class="btn btn-secondary" onclick="window.location.href='/'">
            <i class="bi bi-arrow-left"></i> 返回列表
        </button>
    </div>

    <!-- 备件基本信息 -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-info-circle"></i> 备件基本信息</h5>
        </div>
        <div class="card-body" id="sparePartInfo">
            <div class="text-center" style="color: #cbd5e1;">
                <div class="spinner-border" role="status" style="color: #3b82f6;">
                    <span class="visually-hidden">加载中...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tab导航 -->
    <div class="card mt-3">
        <div class="card-header">
            <ul class="nav nav-tabs card-header-tabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="inbound-tab" data-bs-toggle="tab" data-bs-target="#inbound" type="button" role="tab">
                        <i class="bi bi-box-arrow-in-down"></i> 入库记录
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="outbound-tab" data-bs-toggle="tab" data-bs-target="#outbound" type="button" role="tab">
                        <i class="bi bi-box-arrow-up"></i> 出库记录
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="fault-tab" data-bs-toggle="tab" data-bs-target="#fault" type="button" role="tab">
                        <i class="bi bi-exclamation-triangle"></i> 故障记录
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="maintenance-tab" data-bs-toggle="tab" data-bs-target="#maintenance" type="button" role="tab">
                        <i class="bi bi-tools"></i> 维护记录
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="files-tab" data-bs-toggle="tab" data-bs-target="#files" type="button" role="tab">
                        <i class="bi bi-file-earmark-text"></i> 文件管理
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content">
                <!-- 入库记录 -->
                <div class="tab-pane fade show active" id="inbound" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="bi bi-box-arrow-in-down"></i> 入库记录</h6>
                        <button class="btn btn-sm btn-success" onclick="showAddInboundModal()">
                            <i class="bi bi-plus"></i> 添加入库记录
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>操作者</th>
                                    <th>入库时间</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="inboundTableBody">
                                <tr><td colspan="4" class="text-center" style="color: #94a3b8;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 出库记录 -->
                <div class="tab-pane fade" id="outbound" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="bi bi-box-arrow-up"></i> 出库记录</h6>
                        <button class="btn btn-sm btn-warning" onclick="showAddOutboundModal()">
                            <i class="bi bi-plus"></i> 添加出库记录
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>操作者</th>
                                    <th>出库时间</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="outboundTableBody">
                                <tr><td colspan="4" class="text-center" style="color: #94a3b8;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 故障记录 -->
                <div class="tab-pane fade" id="fault" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="bi bi-exclamation-triangle"></i> 故障记录</h6>
                        <button class="btn btn-sm btn-danger" onclick="showAddFaultModal()">
                            <i class="bi bi-plus"></i> 添加故障记录
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>操作者</th>
                                    <th>故障时间</th>
                                    <th>故障描述</th>
                                    <th>故障类型</th>
                                    <th>维修状态</th>
                                    <th>维修完成日期</th>
                                    <th>维修费用</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="faultTableBody">
                                <tr><td colspan="9" class="text-center" style="color: #94a3b8;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 维护记录 -->
                <div class="tab-pane fade" id="maintenance" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="bi bi-tools"></i> 维护记录</h6>
                        <button class="btn btn-sm btn-info text-white" onclick="showAddMaintenanceModal()">
                            <i class="bi bi-plus"></i> 添加维护记录
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>操作者</th>
                                    <th>维护日期</th>
                                    <th>维护类型</th>
                                    <th>维护内容</th>
                                    <th>上次检定日期</th>
                                    <th>检定有效期（月）</th>
                                    <th>下次检定日期</th>
                                    <th>维护费用</th>
                                    <th>操作</th>
                                </tr>
                            </thead>
                            <tbody id="maintenanceTableBody">
                                <tr><td colspan="10" class="text-center" style="color: #94a3b8;">加载中...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 文件管理 -->
                <div class="tab-pane fade" id="files" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h6><i class="bi bi-file-earmark-text"></i> 文件管理</h6>
                        <button class="btn btn-sm btn-primary" onclick="showUploadModal()">
                            <i class="bi bi-cloud-upload"></i> 上传文件
                        </button>
                    </div>
                    <div class="row" id="filesContainer">
                        <div class="col-12 text-center" style="color: #94a3b8;">加载中...</div>
                    </div>
                </div>
            </div>

            <!-- 导出按钮 -->
            <div class="mt-3">
                <button class="btn btn-success" onclick="exportRecords()">
                    <i class="bi bi-file-earmark-excel"></i> 导出所有记录
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 添加入库记录模态框 -->
<div class="modal fade" id="addInboundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">添加入库记录</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="inboundForm">
                    <div class="mb-3">
                        <label class="form-label">操作者 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="inbound_operator" required placeholder="请输入操作者姓名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="inbound_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-success" onclick="submitInboundRecord()">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加出库记录模态框 -->
<div class="modal fade" id="addOutboundModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">添加出库记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="outboundForm">
                    <div class="mb-3">
                        <label class="form-label">操作者 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="outbound_operator" required placeholder="请输入操作者姓名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="outbound_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="submitOutboundRecord()">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加故障记录模态框 -->
<div class="modal fade" id="addFaultModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">添加故障记录</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="faultForm">
                    <div class="mb-3">
                        <label class="form-label">操作者 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="fault_operator" required placeholder="请输入操作者姓名">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">故障描述 <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="fault_description" rows="3" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">故障类型</label>
                        <select class="form-select" id="fault_type">
                            <option value="">请选择</option>
                            <option value="机械故障">机械故障</option>
                            <option value="电气故障">电气故障</option>
                            <option value="软件故障">软件故障</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">维修状态</label>
                        <select class="form-select" id="fault_repair_status">
                            <option value="待维修" selected>待维修</option>
                            <option value="维修中">维修中</option>
                            <option value="已维修">已维修</option>
                            <option value="无法修复">无法修复</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">维修完成日期</label>
                        <input type="date" class="form-control" id="fault_repair_date">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">维修费用（元）</label>
                        <input type="number" class="form-control" id="fault_repair_cost" step="0.01" min="0">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="fault_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-danger" onclick="submitFaultRecord()">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 添加维护记录模态框 -->
<div class="modal fade" id="addMaintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title"><i class="bi bi-tools"></i> 添加维护记录</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">操作者 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="maintenance_operator" required placeholder="请输入操作者姓名">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="maintenance_date" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护类型</label>
                            <select class="form-select" id="maintenance_type">
                                <option value="">请选择</option>
                                <option value="日常维护">日常维护</option>
                                <option value="检定校准">检定校准</option>
                                <option value="大修">大修</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护费用（元）</label>
                            <input type="number" class="form-control" id="maintenance_cost" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">维护内容</label>
                        <textarea class="form-control" id="maintenance_content" rows="3" placeholder="请描述维护内容"></textarea>
                    </div>
                    <hr>
                    <h6 class="mb-3"><i class="bi bi-calendar-check"></i> 检定信息（可选）</h6>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 填写以下信息后，系统将自动计算下次检定日期，并同步更新备件的检定信息
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">上次检定日期</label>
                            <input type="date" class="form-control" id="maintenance_last_inspection">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">检定有效期（月）</label>
                            <input type="number" class="form-control" id="maintenance_validity_period" min="1" placeholder="例如：12">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="maintenance_remarks" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-info text-white" onclick="submitMaintenanceRecord()">提交</button>
            </div>
        </div>
    </div>
</div>

<!-- 编辑维护记录模态框 -->
<div class="modal fade" id="editMaintenanceModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title"><i class="bi bi-pencil"></i> 编辑维护记录</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editMaintenanceForm">
                    <input type="hidden" id="edit_maintenance_id">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">操作者 <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="edit_maintenance_operator" required placeholder="请输入操作者姓名">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护日期 <span class="text-danger">*</span></label>
                            <input type="date" class="form-control" id="edit_maintenance_date" required>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护类型</label>
                            <select class="form-select" id="edit_maintenance_type">
                                <option value="">请选择</option>
                                <option value="日常维护">日常维护</option>
                                <option value="检定校准">检定校准</option>
                                <option value="大修">大修</option>
                                <option value="其他">其他</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">维护费用（元）</label>
                            <input type="number" class="form-control" id="edit_maintenance_cost" step="0.01" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">维护内容</label>
                        <textarea class="form-control" id="edit_maintenance_content" rows="3" placeholder="请描述维护内容"></textarea>
                    </div>
                    <hr>
                    <h6 class="mb-3"><i class="bi bi-calendar-check"></i> 检定信息（可选）</h6>
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> 填写以下信息后，系统将自动计算下次检定日期，并同步更新备件的检定信息
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">上次检定日期</label>
                            <input type="date" class="form-control" id="edit_maintenance_last_inspection">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">检定有效期（月）</label>
                            <input type="number" class="form-control" id="edit_maintenance_validity_period" min="1" placeholder="例如：12">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="edit_maintenance_remarks" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-warning" onclick="updateMaintenanceRecord()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 上传文件模态框 -->
<div class="modal fade" id="uploadFileModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-cloud-upload"></i> 上传文件</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="uploadForm" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label class="form-label">选择文件 <span class="text-danger">*</span></label>
                        <input type="file" class="form-control" id="file_input" required>
                        <div class="form-text">支持的文件类型：图片(png/jpg/gif)、文档(pdf/doc/docx)、表格(xls/xlsx)、压缩包(zip/rar)等</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">备注</label>
                        <textarea class="form-control" id="file_remarks" rows="2" placeholder="可选：说明文件用途或内容"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="submitUpload()">
                    <i class="bi bi-upload"></i> 上传
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const partId = {{ part_id }};

    $(document).ready(function() {
        loadSparePartInfo();
        loadInboundRecords();
        loadOutboundRecords();
        loadFaultRecords();
        loadMaintenanceRecords();
        loadAttachments();
    });

    // 加载备件信息
    function loadSparePartInfo() {
        $.ajax({
            url: `/api/spare-parts/${partId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displaySparePartInfo(response.data);
                }
            },
            error: function() {
                $('#sparePartInfo').html('<p class="text-danger">加载失败</p>');
            }
        });
    }

    // 显示备件信息
    function displaySparePartInfo(part) {
        const html = `
            <div class="row" style="font-size: 1.05rem;">
                <div class="col-md-6">
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">备件名称：</strong><span style="color: #334155; font-weight: 500;">${part.name}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">资产编号：</strong><span style="color: #334155; font-weight: 500;">${part.asset_number}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">设备类型：</strong><span style="color: #334155; font-weight: 500;">${part.device_type || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">规格型号：</strong><span style="color: #334155; font-weight: 500;">${part.specifications || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">生产厂家：</strong><span style="color: #334155; font-weight: 500;">${part.manufacturer || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">出厂编号：</strong><span style="color: #334155; font-weight: 500;">${part.product_number || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">系统：</strong><span style="color: #334155; font-weight: 500;">${part.ownership || '-'}</span></p>
                </div>
                <div class="col-md-6">
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">使用状态：</strong><span class="badge badge-status status-${part.usage_status}">${part.usage_status}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">存放地点：</strong><span style="color: #334155; font-weight: 500;">${part.storage_location || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">上次检定日期：</strong><span style="color: #334155; font-weight: 500;">${part.last_inspection_date || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">下次检定日期：</strong><span style="color: #334155; font-weight: 500;">${part.next_inspection_date || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">采购日期：</strong><span style="color: #334155; font-weight: 500;">${part.purchase_date || '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">质保期：</strong><span style="color: #334155; font-weight: 500;">${part.warranty_period ? part.warranty_period + ' 月' : '-'}</span></p>
                    <p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">单价：</strong><span style="color: #334155; font-weight: 500;">${part.unit_price ? '¥' + part.unit_price : '-'}</span></p>
                </div>
                ${part.remarks ? `<div class="col-md-12"><p style="margin-bottom: 1rem;"><strong style="color: #1e293b; font-weight: 700;">备注：</strong><span style="color: #334155; font-weight: 500;">${part.remarks}</span></p></div>` : ''}
            </div>
        `;
        $('#sparePartInfo').html(html);
    }

    // 加载入库记录
    function loadInboundRecords() {
        $.ajax({
            url: '/api/inbound-records',
            method: 'GET',
            data: { spare_part_id: partId },
            success: function(response) {
                if (response.success) {
                    displayInboundRecords(response.data);
                }
            }
        });
    }

    function displayInboundRecords(records) {
        const tbody = $('#inboundTableBody');
        tbody.empty();

        if (records.length === 0) {
            tbody.append('<tr><td colspan="4" class="text-center" style="color: #94a3b8;">暂无记录</td></tr>');
            return;
        }

        records.forEach(function(record) {
            tbody.append(`
                <tr>
                    <td>${record.id}</td>
                    <td>${record.operator_name}</td>
                    <td>${record.inbound_date}</td>
                    <td>${record.remarks || '-'}</td>
                </tr>
            `);
        });
    }

    // 加载出库记录
    function loadOutboundRecords() {
        $.ajax({
            url: '/api/outbound-records',
            method: 'GET',
            data: { spare_part_id: partId },
            success: function(response) {
                if (response.success) {
                    displayOutboundRecords(response.data);
                }
            }
        });
    }

    function displayOutboundRecords(records) {
        const tbody = $('#outboundTableBody');
        tbody.empty();

        if (records.length === 0) {
            tbody.append('<tr><td colspan="4" class="text-center" style="color: #94a3b8;">暂无记录</td></tr>');
            return;
        }

        records.forEach(function(record) {
            tbody.append(`
                <tr>
                    <td>${record.id}</td>
                    <td>${record.operator_name}</td>
                    <td>${record.outbound_date}</td>
                    <td>${record.remarks || '-'}</td>
                </tr>
            `);
        });
    }

    // 加载故障记录
    function loadFaultRecords() {
        $.ajax({
            url: '/api/fault-records',
            method: 'GET',
            data: { spare_part_id: partId },
            success: function(response) {
                if (response.success) {
                    displayFaultRecords(response.data);
                }
            }
        });
    }

    function displayFaultRecords(records) {
        const tbody = $('#faultTableBody');
        tbody.empty();

        if (records.length === 0) {
            tbody.append('<tr><td colspan="9" class="text-center" style="color: #94a3b8;">暂无记录</td></tr>');
            return;
        }

        records.forEach(function(record) {
            tbody.append(`
                <tr>
                    <td>${record.id}</td>
                    <td>${record.operator_name}</td>
                    <td>${record.fault_date}</td>
                    <td>${record.fault_description}</td>
                    <td>${record.fault_type || '-'}</td>
                    <td>${record.repair_status}</td>
                    <td>${record.repair_date || '-'}</td>
                    <td>${record.repair_cost ? '¥' + record.repair_cost : '-'}</td>
                    <td>${record.remarks || '-'}</td>
                </tr>
            `);
        });
    }

    // 显示添加模态框
    function showAddInboundModal() {
        $('#inboundForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addInboundModal')).show();
    }

    function showAddOutboundModal() {
        $('#outboundForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addOutboundModal')).show();
    }

    function showAddFaultModal() {
        $('#faultForm')[0].reset();
        new bootstrap.Modal(document.getElementById('addFaultModal')).show();
    }

    // 提交记录
    function submitInboundRecord() {
        const data = {
            spare_part_id: partId,
            quantity: 1,  // 默认数量为1
            operator_name: $('#inbound_operator').val(),
            remarks: $('#inbound_remarks').val()
        };

        if (!data.operator_name) {
            showAlert('请选择操作者', 'warning');
            return;
        }

        $.ajax({
            url: '/api/inbound-records',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('入库记录添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addInboundModal')).hide();
                    loadInboundRecords();
                }
            },
            error: function() {
                showAlert('添加失败', 'danger');
            }
        });
    }

    function submitOutboundRecord() {
        const data = {
            spare_part_id: partId,
            quantity: 1,  // 默认数量为1
            operator_name: $('#outbound_operator').val(),
            remarks: $('#outbound_remarks').val()
        };

        if (!data.operator_name) {
            showAlert('请选择操作者', 'warning');
            return;
        }

        $.ajax({
            url: '/api/outbound-records',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('出库记录添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addOutboundModal')).hide();
                    loadOutboundRecords();
                }
            },
            error: function() {
                showAlert('添加失败', 'danger');
            }
        });
    }

    function submitFaultRecord() {
        const data = {
            spare_part_id: partId,
            operator_name: $('#fault_operator').val(),
            fault_description: $('#fault_description').val(),
            fault_type: $('#fault_type').val(),
            repair_status: $('#fault_repair_status').val(),
            repair_date: $('#fault_repair_date').val(),
            repair_cost: $('#fault_repair_cost').val() ? parseFloat($('#fault_repair_cost').val()) : null,
            remarks: $('#fault_remarks').val()
        };

        if (!data.operator_name || !data.fault_description) {
            showAlert('请填写必填项', 'warning');
            return;
        }

        $.ajax({
            url: '/api/fault-records',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('故障记录添加成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addFaultModal')).hide();
                    loadFaultRecords();
                }
            },
            error: function() {
                showAlert('添加失败', 'danger');
            }
        });
    }

    // 加载维护记录
    function loadMaintenanceRecords() {
        $.ajax({
            url: '/api/maintenance-records',
            method: 'GET',
            data: { spare_part_id: partId },
            success: function(response) {
                if (response.success) {
                    displayMaintenanceRecords(response.data);
                }
            }
        });
    }

    function displayMaintenanceRecords(records) {
        const tbody = $('#maintenanceTableBody');
        tbody.empty();

        if (records.length === 0) {
            tbody.append('<tr><td colspan="10" class="text-center" style="color: #94a3b8;">暂无记录</td></tr>');
            return;
        }

        records.forEach(function(record) {
            // 维护内容截断显示
            let contentDisplay = '-';
            if (record.maintenance_content) {
                const content = record.maintenance_content;
                if (content.length > 20) {
                    contentDisplay = `<span title="${content}" style="cursor: help;">${content.substring(0, 20)}...</span>`;
                } else {
                    contentDisplay = content;
                }
            }
            
            tbody.append(`
                <tr>
                    <td>${record.id}</td>
                    <td>${record.operator_name}</td>
                    <td>${record.maintenance_date}</td>
                    <td>${record.maintenance_type || '-'}</td>
                    <td>${contentDisplay}</td>
                    <td>${record.last_inspection_date || '-'}</td>
                    <td>${record.inspection_validity_period || '-'}</td>
                    <td>${record.next_inspection_date || '-'}</td>
                    <td>${record.maintenance_cost ? '￥' + record.maintenance_cost : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-outline-primary" onclick="editMaintenanceRecord(${record.id})" title="编辑">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteMaintenanceRecord(${record.id})" title="删除">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `);
        });
    }

    // 显示添加维护记录模态框
    function showAddMaintenanceModal() {
        $('#maintenanceForm')[0].reset();
        // 设置默认日期为今天
        const today = new Date().toISOString().split('T')[0];
        $('#maintenance_date').val(today);
        new bootstrap.Modal(document.getElementById('addMaintenanceModal')).show();
    }

    function submitMaintenanceRecord() {
        const data = {
            spare_part_id: partId,
            operator_name: $('#maintenance_operator').val(),
            maintenance_date: $('#maintenance_date').val(),
            maintenance_type: $('#maintenance_type').val(),
            maintenance_content: $('#maintenance_content').val(),
            last_inspection_date: $('#maintenance_last_inspection').val(),
            inspection_validity_period: $('#maintenance_validity_period').val() ? parseInt($('#maintenance_validity_period').val()) : null,
            maintenance_cost: $('#maintenance_cost').val() ? parseFloat($('#maintenance_cost').val()) : null,
            remarks: $('#maintenance_remarks').val()
        };

        if (!data.operator_name || !data.maintenance_date) {
            showAlert('请填写必填项', 'warning');
            return;
        }

        $.ajax({
            url: '/api/maintenance-records',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('维护记录添加成功，备件信息已同步更新', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('addMaintenanceModal')).hide();
                    loadMaintenanceRecords();
                    // 重新加载备件信息以更新检定日期
                    loadSparePartInfo();
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert('添加失败：' + (response ? response.message : '网络错误'), 'danger');
            }
        });
    }

    function deleteMaintenanceRecord(recordId) {
        if (!confirm('确定要删除这条维护记录吗？')) {
            return;
        }

        $.ajax({
            url: `/api/maintenance-records/${recordId}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert('维护记录删除成功', 'success');
                    loadMaintenanceRecords();
                }
            },
            error: function() {
                showAlert('删除失败', 'danger');
            }
        });
    }

    // 编辑维护记录
    function editMaintenanceRecord(recordId) {
        // 获取记录详情
        $.ajax({
            url: `/api/maintenance-records/${recordId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    const record = response.data;
                    // 填充表单
                    $('#edit_maintenance_id').val(record.id);
                    $('#edit_maintenance_operator').val(record.operator_name);
                    $('#edit_maintenance_date').val(record.maintenance_date);
                    $('#edit_maintenance_type').val(record.maintenance_type || '');
                    $('#edit_maintenance_cost').val(record.maintenance_cost || '');
                    $('#edit_maintenance_content').val(record.maintenance_content || '');
                    $('#edit_maintenance_last_inspection').val(record.last_inspection_date || '');
                    $('#edit_maintenance_validity_period').val(record.inspection_validity_period || '');
                    $('#edit_maintenance_remarks').val(record.remarks || '');
                    
                    // 显示模态框
                    new bootstrap.Modal(document.getElementById('editMaintenanceModal')).show();
                }
            },
            error: function() {
                showAlert('获取记录详情失败', 'danger');
            }
        });
    }

    function updateMaintenanceRecord() {
        const recordId = $('#edit_maintenance_id').val();
        const data = {
            operator_name: $('#edit_maintenance_operator').val(),
            maintenance_date: $('#edit_maintenance_date').val(),
            maintenance_type: $('#edit_maintenance_type').val(),
            maintenance_content: $('#edit_maintenance_content').val(),
            last_inspection_date: $('#edit_maintenance_last_inspection').val(),
            inspection_validity_period: $('#edit_maintenance_validity_period').val() ? parseInt($('#edit_maintenance_validity_period').val()) : null,
            maintenance_cost: $('#edit_maintenance_cost').val() ? parseFloat($('#edit_maintenance_cost').val()) : null,
            remarks: $('#edit_maintenance_remarks').val()
        };

        if (!data.operator_name || !data.maintenance_date) {
            showAlert('请填写必填项', 'warning');
            return;
        }

        $.ajax({
            url: `/api/maintenance-records/${recordId}`,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: function(response) {
                if (response.success) {
                    showAlert('维护记录更新成功，备件信息已同步更新', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('editMaintenanceModal')).hide();
                    loadMaintenanceRecords();
                    // 重新加载备件信息以更新检定日期
                    loadSparePartInfo();
                }
            },
            error: function(xhr) {
                const response = xhr.responseJSON;
                showAlert('更新失败：' + (response ? response.message : '网络错误'), 'danger');
            }
        });
    }

    // 导出记录
    function exportRecords() {
        window.location.href = `/api/export/records?spare_part_id=${partId}`;
    }

    function showAlert(message, type) {
        const alert = $(`
            <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index: 9999; min-width: 300px;">
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `);
        $('body').append(alert);
        setTimeout(function() {
            alert.alert('close');
        }, 3000);
    }

    // 加载附件列表
    function loadAttachments() {
        $.ajax({
            url: `/api/attachments/${partId}`,
            method: 'GET',
            success: function(response) {
                if (response.success) {
                    displayAttachments(response.data);
                }
            },
            error: function() {
                $('#filesContainer').html('<div class="col-12 text-center text-danger">加载失败</div>');
            }
        });
    }

    // 显示附件列表
    function displayAttachments(attachments) {
        const container = $('#filesContainer');
        container.empty();

        if (attachments.length === 0) {
            container.append('<div class="col-12 text-center" style="color: #94a3b8;">还没有上传任何文件</div>');
            return;
        }

        // 使用列表形式显示
        let listHtml = '<div class="col-12"><div class="list-group">';
        
        attachments.forEach(function(att) {
            const fileSize = (att.file_size / 1024).toFixed(2); // KB
            const fileSizeMB = (att.file_size / (1024 * 1024)).toFixed(2); // MB
            const displaySize = att.file_size > 1024 * 1024 ? fileSizeMB + ' MB' : fileSize + ' KB';
            const fileIcon = getFileIcon(att.filename);
            const uploadDate = att.upload_date.split(' ')[0]; // 只显示日期部分
            
            listHtml += `
                <div class="list-group-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div class="flex-grow-1 me-3">
                            <h6 class="mb-1">
                                <i class="bi ${fileIcon}"></i> 
                                <strong>${att.filename}</strong>
                            </h6>
                            <small class="text-muted">
                                <i class="bi bi-calendar3"></i> ${uploadDate}
                                <span class="ms-2"><i class="bi bi-hdd"></i> ${displaySize}</span>
                                ${att.remarks ? '<span class="ms-2"><i class="bi bi-chat-left-text"></i> ' + att.remarks + '</span>' : ''}
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <a href="/api/attachments/download/${att.id}" class="btn btn-outline-primary" title="下载">
                                <i class="bi bi-download"></i> 下载
                            </a>
                            <button class="btn btn-outline-danger" onclick="deleteAttachment(${att.id})" title="删除">
                                <i class="bi bi-trash"></i> 删除
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        listHtml += '</div></div>';
        container.append(listHtml);
    }

    // 根据文件名获取图标
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': 'bi-file-earmark-pdf-fill text-danger',
            'doc': 'bi-file-earmark-word-fill text-primary',
            'docx': 'bi-file-earmark-word-fill text-primary',
            'xls': 'bi-file-earmark-excel-fill text-success',
            'xlsx': 'bi-file-earmark-excel-fill text-success',
            'png': 'bi-file-earmark-image-fill text-info',
            'jpg': 'bi-file-earmark-image-fill text-info',
            'jpeg': 'bi-file-earmark-image-fill text-info',
            'gif': 'bi-file-earmark-image-fill text-info',
            'bmp': 'bi-file-earmark-image-fill text-info',
            'zip': 'bi-file-earmark-zip-fill text-warning',
            'rar': 'bi-file-earmark-zip-fill text-warning',
            'txt': 'bi-file-earmark-text-fill'
        };
        return iconMap[ext] || 'bi-file-earmark-fill';
    }

    // 显示上传模态框
    function showUploadModal() {
        $('#uploadForm')[0].reset();
        new bootstrap.Modal(document.getElementById('uploadFileModal')).show();
    }

    // 提交上传
    function submitUpload() {
        const fileInput = document.getElementById('file_input');
        const remarks = $('#file_remarks').val();

        if (!fileInput.files || fileInput.files.length === 0) {
            showAlert('请选择文件', 'warning');
            return;
        }

        const file = fileInput.files[0];
        const maxSize = 100 * 1024 * 1024; // 100MB
        
        if (file.size > maxSize) {
            showAlert('文件大小超过100MB限制', 'warning');
            return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('spare_part_id', partId);
        formData.append('remarks', remarks);

        console.log('开始上传文件:', file.name, '大小:', (file.size / 1024).toFixed(2), 'KB');

        // 显示上传进度
        const uploadBtn = $('button[onclick="submitUpload()"]');
        const originalText = uploadBtn.html();
        uploadBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-1"></span>上传中...');

        $.ajax({
            url: '/api/attachments/upload',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            timeout: 120000, // 120秒超时
            success: function(response) {
                console.log('上传响应:', response);
                if (response.success) {
                    showAlert('文件上传成功', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('uploadFileModal')).hide();
                    $('#file_input').val('');
                    $('#file_remarks').val('');
                    loadAttachments();
                } else {
                    showAlert('上传失败：' + response.message, 'danger');
                }
            },
            error: function(xhr, status, error) {
                console.error('上传失败:', status, error, xhr);
                let errorMsg = '网络错误，请稍后重试';
                
                if (xhr.status === 413) {
                    errorMsg = '文件大小超过限制';
                } else if (xhr.status === 400 || xhr.status === 500) {
                    try {
                        const response = xhr.responseJSON;
                        if (response && response.message) {
                            errorMsg = response.message;
                        }
                    } catch (e) {
                        errorMsg = '服务器错误: ' + xhr.statusText;
                    }
                } else if (status === 'timeout') {
                    errorMsg = '上传超时，请检查网络连接或减小文件大小';
                } else if (status === 'error') {
                    errorMsg = '无法连接到服务器，请检查服务器是否运行';
                }
                
                showAlert('上传失败：' + errorMsg, 'danger');
            },
            complete: function() {
                uploadBtn.prop('disabled', false).html(originalText);
            }
        });
    }

    // 删除附件
    function deleteAttachment(attachmentId) {
        if (!confirm('确定要删除这个文件吗？')) {
            return;
        }

        $.ajax({
            url: `/api/attachments/${attachmentId}`,
            method: 'DELETE',
            success: function(response) {
                if (response.success) {
                    showAlert('文件删除成功', 'success');
                    loadAttachments();
                } else {
                    showAlert('删除失败：' + response.message, 'danger');
                }
            },
            error: function() {
                showAlert('网络错误，请稍后重试', 'danger');
            }
        });
    }
</script>
{% endblock %}

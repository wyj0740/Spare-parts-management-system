# 数据库更新说明

## 如何确保程序更新后数据库不丢失

本系统已经内置了数据库迁移机制，可以在程序更新时自动保留和升级数据库。

### 数据文件位置

程序运行时会在以下位置创建数据文件：

```
项目目录/
├── data/                    # 数据库目录
│   └── spare_parts.db      # 主数据库文件
├── uploads/                # 上传的文件
├── logs/                   # 日志文件
└── db_backups/             # 数据库备份（自动创建）
```

### 更新程序的步骤

#### 方式一：开发环境更新（推荐）

1. **备份当前数据**（可选，系统会自动备份）
   ```bash
   python db_migration.py
   ```

2. **更新代码**
   ```bash
   git pull
   # 或者直接替换新的 app.py 文件
   ```

3. **启动程序**
   ```bash
   python app.py
   ```
   
   程序会自动：
   - 检测数据库版本
   - 如需要，自动执行迁移
   - 备份旧数据
   - 升级数据库结构

#### 方式二：打包后的可执行文件

1. **关闭旧版本程序**

2. **保留这些文件夹**（重要！）：
   - `data/` - 包含所有数据
   - `uploads/` - 包含所有上传的文件
   - `logs/` - 包含日志（可选）

3. **替换新的 exe 文件**

4. **启动新版本程序**
   - 系统自动检测并升级数据库
   - 所有数据完整保留

### 数据备份

#### 自动备份
程序每次启动时会自动检查数据库版本，如需迁移会自动备份到 `db_backups/` 目录。

#### 手动备份
运行备份工具：
```bash
python db_migration.py
```

备份文件格式：`spare_parts_backup_YYYYMMDD_HHMMSS.db`

### 恢复数据

如果更新出现问题，可以从备份恢复：

1. 关闭程序
2. 从 `db_backups/` 目录找到备份文件
3. 复制备份文件到 `data/` 目录
4. 重命名为 `spare_parts.db`
5. 重新启动程序

### 数据库版本管理

系统使用版本号管理数据库结构：
- **当前版本**：在 `db_migration.py` 中的 `CURRENT_DB_VERSION` 定义
- **升级机制**：每个版本的升级逻辑独立编写
- **向后兼容**：新版本可以自动升级旧数据库

### 重要提示

✅ **必须保留的文件/目录**：
- `data/spare_parts.db` - 主数据库
- `uploads/` - 上传的文件（图片、文档等）

✅ **建议保留的文件/目录**：
- `logs/` - 日志文件
- `db_backups/` - 数据库备份

❌ **可以删除的文件**：
- `__pycache__/` - Python缓存
- `.pyc` 文件 - 编译的Python文件

### 常见问题

**Q: 更新程序会丢失数据吗？**
A: 不会。只要保留 `data/` 和 `uploads/` 目录，所有数据都会保留。

**Q: 如何确认数据库已成功升级？**
A: 启动程序时会在控制台显示：
```
正在检查数据库...
当前数据库版本: X
程序要求版本: Y
✓ 数据库检查完成
```

**Q: 如果迁移失败怎么办？**
A: 系统会自动备份，可以从 `db_backups/` 目录恢复备份文件。

**Q: 可以在多台电脑之间共享数据吗？**
A: 可以。复制整个 `data/` 和 `uploads/` 目录到另一台电脑即可。

### 技术细节

数据库迁移系统包含：
- **版本表**：`db_version` 记录数据库版本历史
- **增量迁移**：只执行需要的版本升级
- **自动备份**：迁移前自动备份数据库
- **错误回滚**：迁移失败时提示恢复方法

### 联系支持

如有问题，请查看：
- 日志文件：`logs/spare_parts.log`
- 或联系开发者：wyj (1796085559@qq.com)
